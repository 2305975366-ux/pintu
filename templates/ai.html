<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 生成图片</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
{% include '_navbar.html' %}
<div class="background-blur"></div>
<div class="container" style="max-width: 1100px; margin: 20px auto;">
  <style>
    .ai-layout{display:flex;gap:20px;align-items:flex-start;height:680px}
    .ai-left{flex:0 0 260px;height:680px;overflow:auto}
    .ai-right{flex:1 1 auto;display:flex;flex-direction:column;gap:16px;height:680px}
    .ai-result{flex: 2 1 0;min-height:0;display:flex;align-items:center;justify-content:center}
    .ai-result img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px}
    .ai-chat{flex: 1 1 0;min-height:0;display:flex;flex-direction:column;padding:0;overflow:hidden}
    .ai-chat-box{height:100%;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
    .ai-chat-input{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,0.1)}
    .ai-tag-title{font-size:14px;margin:6px 0 8px;color:#F9E078;opacity:.9}
    .ai-tags{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .tag-btn{height:36px;display:inline-flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.15);background:transparent;color:#F9E078;border-radius:6px;cursor:pointer}
    .tag-btn:hover{background:rgba(249,224,120,0.08)}
    .tag-btn.active{outline:2px solid #F9E078}
  </style>
  <div class="ai-layout">
    <!-- 左侧：预置 Prompt 标签 -->
    <aside class="card ai-left">
      <h3 style="margin-bottom:12px;">常用标签</h3>
      <div id="promptTags">
        <div class="ai-tag-title">尺寸</div>
        <div class="ai-tags" id="sizeTags">
          <button class="tag-btn" data-size="1024x1024">1024×1024</button>
          <button class="tag-btn" data-size="1280x720">1280×720</button>
          <button class="tag-btn" data-size="1024x768">1024×768</button>
          <button class="tag-btn" data-size="720x1280">720×1280</button>
        </div>
        <div class="ai-tag-title">画风</div>
        <div class="ai-tags">
          <button class="tag-btn" data-val="像素风">像素风</button>
          <button class="tag-btn" data-val="赛博朋克">赛博朋克</button>
          <button class="tag-btn" data-val="蒸汽波">蒸汽波</button>
          <button class="tag-btn" data-val="水彩">水彩</button>
          <button class="tag-btn" data-val="油画">油画</button>
          <button class="tag-btn" data-val="低多边形">低多边形</button>
          <button class="tag-btn" data-val="漫画">漫画</button>
          <button class="tag-btn" data-val="日系">日系</button>
          <button class="tag-btn" data-val="写实">写实</button>
          <button class="tag-btn" data-val="3D渲染">3D渲染</button>
        </div>
        <div class="ai-tag-title">图片类型</div>
        <div class="ai-tags">
          <button class="tag-btn" data-val="自然风景">自然风景</button>
          <button class="tag-btn" data-val="城市夜景">城市夜景</button>
          <button class="tag-btn" data-val="人物肖像">人物肖像</button>
          <button class="tag-btn" data-val="动物">动物</button>
          <button class="tag-btn" data-val="建筑">建筑</button>
          <button class="tag-btn" data-val="食物">食物</button>
          <button class="tag-btn" data-val="科幻机甲">科幻机甲</button>
          <button class="tag-btn" data-val="奇幻">奇幻</button>
        </div>
        <div class="ai-tag-title">其他</div>
        <div class="ai-tags">
          <button class="tag-btn" data-val="黄昏光影">黄昏光影</button>
          <button class="tag-btn" data-val="体积光">体积光</button>
          <button class="tag-btn" data-val="高对比">高对比</button>
          <button class="tag-btn" data-val="柔和色调">柔和色调</button>
          <button class="tag-btn" data-val="冷色调">冷色调</button>
          <button class="tag-btn" data-val="暖色调">暖色调</button>
        </div>
      </div>
    </aside>

    <!-- 右侧：上图下对话输入 -->
    <section class="ai-right">
      <!-- 生成结果展示 -->
      <div id="aiResult" class="card ai-result">
        <img id="aiImg" src="" alt="AI图片" style="display:none;">
        <div id="aiPlaceholder" style="color:#F9E078; opacity:.7;">生成结果将显示在这里</div>
      </div>

      <!-- 对话+输入区 -->
      <div class="card ai-chat">
        <div id="chatBox" class="ai-chat-box"></div>
        <div class="ai-chat-input">
          <input id="aiPrompt" placeholder="输入描述，例如：像素风森林中的小屋，黄昏光影" style="flex:1; padding:10px 12px; border:1px solid #E5E7EB; border-radius:6px;">
          <button id="genBtn" class="btn btn-primary">生成</button>
        </div>
        <div style="padding: 0 12px 12px 12px;"><span id="aiTip" style="font-size:12px;color:#F9E078;opacity:.8;"></span></div>
      </div>
    </section>
  </div>
</div>
<script>
const genBtn=document.getElementById('genBtn');
const aiPrompt=document.getElementById('aiPrompt');
const aiTip=document.getElementById('aiTip');
const aiResult=document.getElementById('aiResult');
const aiImg=document.getElementById('aiImg');
const aiPlaceholder=document.getElementById('aiPlaceholder');
const chatBox=document.getElementById('chatBox');
const promptTags=document.getElementById('promptTags');
const sizeTags=document.getElementById('sizeTags');
let selectedSize=null; // e.g. "1024x1024"

function appendMsg(who,text){
  const row=document.createElement('div');
  row.style.display='flex';
  row.style.gap='8px';
  row.style.alignItems='flex-start';
  const badge=document.createElement('span');
  badge.textContent=who;
  badge.style.background='rgba(249,224,120,0.12)';
  badge.style.border='1px solid rgba(249,224,120,0.35)';
  badge.style.color='#F9E078';
  badge.style.borderRadius='6px';
  badge.style.fontSize='12px';
  badge.style.padding='2px 6px';
  const textEl=document.createElement('div');
  textEl.textContent=text;
  row.appendChild(badge);
  row.appendChild(textEl);
  chatBox.appendChild(row);
  chatBox.scrollTop=chatBox.scrollHeight;
}

promptTags.addEventListener('click',(e)=>{
  if(e.target && e.target.matches('button[data-val]')){
    const val=e.target.getAttribute('data-val');
    if(aiPrompt.value){ aiPrompt.value += '，' + val; } else { aiPrompt.value = val; }
    aiPrompt.focus();
  }
});

sizeTags.addEventListener('click',(e)=>{
  if(e.target && e.target.matches('button[data-size]')){
    // toggle active
    [...sizeTags.querySelectorAll('button')].forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    selectedSize=e.target.getAttribute('data-size');
  }
});

genBtn.addEventListener('click', async ()=>{
  const token=localStorage.getItem('puzzleToken');
  if(!token){
    aiTip.textContent='请先登录后再使用 AI 生成功能。';
    return;
  }
  const prompt=(aiPrompt.value||'').trim();
  if(!prompt){ aiTip.textContent='请输入描述'; return; }
  aiTip.textContent='生成中...';
  appendMsg('我', prompt);
  try{
    const form=new FormData();
    form.append('prompt', prompt);
    const res=await fetch('/ai/generate',{ method:'POST', body:form });
    const json=await res.json();
    if(json.code===200 && json.data && json.data.url){
      let url=json.data.url;
      if(selectedSize){
        const [w,h]=selectedSize.split('x');
        url += `?width=${encodeURIComponent(w)}&height=${encodeURIComponent(h)}`;
      }
      aiImg.src=url;
      aiResult.style.display='flex';
      aiImg.style.display='block';
      if(aiPlaceholder) aiPlaceholder.style.display='none';
      appendMsg('AI', '已生成图片，见上方预览');
      aiTip.textContent='';
    }else{
      aiTip.textContent=json.message||'生成失败';
      appendMsg('AI', '生成失败');
    }
  }catch(e){ aiTip.textContent='网络错误'; }
});
</script>
</body>
</html>


