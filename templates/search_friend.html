<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>添加好友</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
    @media (max-width: 700px) {
      .container { padding: 0 4vw; }
      .friend-flex { flex-direction: column !important; gap: 16px !important; }
      .friend-flex > div { width: 100% !important; }
      .card { padding: 12px !important; }
    }
    </style>
</head>
<body>
{% include '_navbar.html' %}
<div class="background-blur"></div>
<div class="container" style="max-width: 700px; margin: 0 auto;">
    <div class="page-title" style="margin-top: 20px; display: flex; align-items: center;">
        <button class="btn btn-secondary back-btn" onclick="window.location.href='{{ url_for('main') }}'" style="padding: 8px 16px; font-size: 12px; margin-right: 16px;">
            <span class="chinese-text">返回</span>
        </button>
        <span class="chinese-text" style="color: #F9E078; font-size: 18px;">添加好友</span>
    </div>
    <div class="card" style="background-color: #20223A; padding: 24px; margin-top: 20px;">
        <div class="friend-flex" style="display: flex; gap: 32px;">
            <!-- 搜索用户 -->
            <div style="flex: 1;">
                <div style="color: #F9E078; font-size: 15px; margin-bottom: 12px;" class="chinese-text">搜索玩家</div>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input id="searchInput" type="text" placeholder="输入用户名..." style="flex: 1; padding: 8px 12px; background-color: #23244A; border: 2px solid #F9E078; color: #E0E0E0; font-size: 13px; border-radius: 4px;">
                    <button id="searchBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;">
                        <span class="chinese-text">搜索</span>
                    </button>
                </div>
                <div id="searchResult" style="background: #2A2D4A; border-radius: 6px; min-height: 60px; max-height: 300px; overflow-y: auto; padding: 8px;">
                    <p class="chinese-text" style="color: #B8BCC8; text-align: center;">请输入用户名进行搜索</p>
                </div>
            </div>
            <!-- 好友请求处理 -->
            <div style="width: 240px;">
                <div style="color: #F9E078; font-size: 15px; margin-bottom: 12px;" class="chinese-text">好友请求</div>
                <div id="requestList" style="background: #2A2D4A; border-radius: 6px; min-height: 60px; max-height: 300px; overflow-y: auto; padding: 8px;">
                    <p class="chinese-text" style="color: #B8BCC8; text-align: center;">暂无好友请求</p>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
let myUserId = localStorage.getItem('userId');

// 搜索用户
document.getElementById('searchBtn').onclick = function() {
    const kw = document.getElementById('searchInput').value.trim();
    if (!kw) return;
    fetch('/social/search_user?keyword=' + encodeURIComponent(kw), {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('puzzleToken') }
    })
    .then(res => res.json())
    .then(data => {
        const box = document.getElementById('searchResult');
        box.innerHTML = '';
        if (!data.data || data.data.length === 0) {
            box.innerHTML = '<p class="chinese-text" style="color: #B8BCC8; text-align: center;">未找到相关用户</p>';
        } else {
            data.data.forEach(user => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 10px 8px; margin-bottom: 6px; border-radius: 4px; color: #E0E0E0; display: flex; align-items: center; justify-content: space-between;';
                div.innerHTML = `
                    <span>${user.username}${user.user_id == myUserId ? '（你自己）' : ''}</span>
                    ${user.user_id != myUserId ? `<button class="btn btn-primary" style="padding: 4px 12px; font-size: 12px;" onclick="sendRequest(${user.user_id}, this)">加好友</button>` : ''}
                `;
                box.appendChild(div);
            });
        }
    });
};

// 发送好友请求
function sendRequest(uid, btn) {
    btn.disabled = true;
    fetch('/social/send_friend_request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('puzzleToken')
        },
        body: JSON.stringify({receiver_id: uid})
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        btn.disabled = false;
    });
}

// 获取好友请求
function fetchRequests() {
    fetch('/social/get_friend_requests', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('puzzleToken') }
    })
    .then(res => res.json())
    .then(data => {
        const box = document.getElementById('requestList');
        box.innerHTML = '';
        if (!data.data || data.data.length === 0) {
            box.innerHTML = '<p class="chinese-text" style="color: #B8BCC8; text-align: center;">暂无好友请求</p>';
        } else {
            data.data.forEach(req => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 10px 8px; margin-bottom: 6px; border-radius: 4px; color: #E0E0E0; display: flex; align-items: center; justify-content: space-between;';
                div.innerHTML = `
                    <span>${req.sender_name}</span>
                    <span>
                        <button class="btn btn-primary" style="padding: 4px 10px; font-size: 12px;" onclick="handleReq(${req.request_id}, 'accept', this)">同意</button>
                        <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 12px; margin-left: 6px;" onclick="handleReq(${req.request_id}, 'reject', this)">拒绝</button>
                    </span>
                `;
                box.appendChild(div);
            });
        }
    });
}

// 处理好友请求
function handleReq(request_id, action, btn) {
    btn.disabled = true;
    fetch('/social/handle_friend_request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('puzzleToken')
        },
        body: JSON.stringify({request_id, action})
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        fetchRequests();
    });
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    fetchRequests();
});
</script>
</body>
</html>