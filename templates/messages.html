<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>消息中心</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/game-rank.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
    @media (max-width: 700px) {
      .container {
        padding: 0 4vw;
      }
      .msg-flex {
        flex-direction: column !important;
        gap: 16px !important;
      }
      .msg-flex > div:first-child {
        width: 100% !important;
        margin-bottom: 12px;
      }
      #friendList {
        min-height: 60px !important;
        max-height: 120px !important;
        display: flex;
        flex-direction: row;
        overflow-x: auto;
        overflow-y: hidden;
        gap: 8px;
        padding: 8px 0 8px 8px !important;
      }
      .friend-item {
        min-width: 70px;
        text-align: center;
        margin-bottom: 0 !important;
      }
      #chatBox {
        min-height: 200px !important;
        max-height: 300px !important;
      }
      .page-title {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 8px;
      }
      .card {
        padding: 12px !important;
      }
    }
    </style>
</head>
<body>
{% include '_navbar.html' %}
<div class="background-blur"></div>
<div class="container" style="max-width: 1000px; margin: 0 auto;">
    <div class="page-title" style="margin-top: 20px; display: flex; align-items: center;">
        <button class="btn btn-secondary back-btn" onclick="window.location.href='{{ url_for('main') }}'" style="padding: 8px 16px; font-size: 12px; margin-right: 16px;">
            <span class="chinese-text">返回</span>
        </button>
        <span class="chinese-text" style="color: #F9E078; font-size: 18px;">消息中心</span>
    </div>

    <div class="card" style="background-color: #20223A; padding: 24px; margin-top: 20px;">
        <div class="msg-flex" style="display: flex; gap: 32px;">
            <!-- 好友列表 -->
            <div style="width: 220px;">
                <div style="color: #F9E078; font-size: 15px; margin-bottom: 12px;" class="chinese-text">好友列表</div>
                <div id="friendList" style="background: #2A2D4A; border-radius: 6px; min-height: 320px; max-height: 400px; overflow-y: auto; padding: 8px;">
                    <p class="chinese-text" style="color: #B8BCC8; text-align: center;">加载中...</p>
                </div>
                <div style="margin-top: 10px;">
                    <input id="friendSearch" type="text" placeholder="搜索好友..." style="width: 100%; padding: 6px 10px; background-color: #23244A; border: 1.5px solid #F9E078; color: #E0E0E0; font-size: 13px; border-radius: 4px;">
                </div>
            </div>
            <!-- 聊天窗口 -->
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div style="color: #F9E078; font-size: 15px; margin-bottom: 12px;" class="chinese-text" id="chatTitle">请选择好友开始聊天</div>
                <div id="chatBox" style="background: #2A2D4A; border-radius: 6px; flex: 1; min-height: 320px; max-height: 400px; overflow-y: auto; padding: 12px; margin-bottom: 16px;">
                    <p class="chinese-text" style="color: #B8BCC8; text-align: center;">暂无消息</p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <input id="msgInput" type="text" placeholder="输入消息..." style="flex: 1; padding: 8px 12px; background-color: #23244A; border: 2px solid #F9E078; color: #E0E0E0; font-size: 13px; border-radius: 4px;">
                    <button id="sendBtn" class="btn btn-primary" style="padding: 8px 20px; font-size: 13px;">
                        <span class="chinese-text">发送</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
let currentFriendId = null;
let myUserId = localStorage.getItem('userId');

// 加载好友列表
function fetchFriends(search='') {
    fetch('/social/get_friends' + (search ? '?search=' + encodeURIComponent(search) : ''), {
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('puzzleToken')
        }
    })
    .then(res => res.json())
    .then(data => {
        const list = document.getElementById('friendList');
        list.innerHTML = '';
        if (!data.data || data.data.length === 0) {
            list.innerHTML = '<p class="chinese-text" style="color: #B8BCC8; text-align: center;">暂无好友，快去添加吧！</p>';
        } else {
            data.data.forEach(friend => {
                const div = document.createElement('div');
                div.className = 'friend-item';
                div.style.cssText = 'padding: 10px 8px; margin-bottom: 6px; border-radius: 4px; cursor: pointer; color: #E0E0E0;';
                div.innerText = friend.username;
                div.onclick = function() {
                    currentFriendId = friend.user_id;
                    document.getElementById('chatTitle').innerText = '与 ' + friend.username + ' 的聊天';
                    loadMessages(friend.user_id);
                };
                list.appendChild(div);
            });
        }
    });
}

// 搜索好友
document.getElementById('friendSearch').oninput = function() {
    fetchFriends(this.value.trim());
};

// 加载消息
function loadMessages(friendId) {
    fetch('/social/get_messages?friend_id=' + friendId, {
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('puzzleToken')
        }
    })
    .then(res => res.json())
    .then(data => {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML = '';
        if (!data.data || data.data.length === 0) {
            chatBox.innerHTML = '<p class="chinese-text" style="color: #B8BCC8; text-align: center;">暂无消息</p>';
        } else {
            data.data.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.style.cssText = 'margin-bottom: 10px; display: flex; flex-direction: column; align-items: ' + (msg.sender_id == myUserId ? 'flex-end' : 'flex-start') + ';';
                msgDiv.innerHTML = `
                    <span style="background: ${msg.sender_id == myUserId ? '#F9E078' : '#393B5A'}; color: ${msg.sender_id == myUserId ? '#23244A' : '#F9E078'}; padding: 6px 14px; border-radius: 16px; font-size: 13px; max-width: 70%; word-break: break-all; display: inline-block;">
                        ${msg.content}
                    </span>
                    <span style="font-size: 11px; color: #B8BCC8; margin-top: 2px;">${msg.sent_at}</span>
                `;
                chatBox.appendChild(msgDiv);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    });
}

// 发送消息
document.getElementById('sendBtn').onclick = function() {
    const input = document.getElementById('msgInput');
    const content = input.value.trim();
    if (!currentFriendId) {
        alert('请选择好友');
        return;
    }
    if (!content) return;
    fetch('/social/send_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('puzzleToken')
        },
        body: JSON.stringify({receiver_id: currentFriendId, content})
    })
    .then(res => res.json())
    .then(data => {
        if (data.code === 200) {
            loadMessages(currentFriendId);
            input.value = '';
        } else {
            alert(data.message || '发送失败');
        }
    });
};

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    fetchFriends();
});
</script>
    </body>
</html>